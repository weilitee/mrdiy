import pandas as pd

# Load your raw data
df = pd.read_csv(r"C:\Users\weili\Downloads\MRDIY_DE\sql_test-raw.csv")  # replace with your actual file path

# Step 1: Calculate profit and monthly totals per category
df['profit'] = df['sales_amt'] - df['sales_cost']

# Calculate monthly totals per category
totals = df.groupby(['month', 'category']).agg(
    total_qty_cat=('sales_qty', 'sum'),
    total_amt_cat=('sales_amt', 'sum'),
    total_cost_cat=('sales_cost', 'sum'),
    total_profit_cat=('profit', 'sum')
).reset_index()

# Merge totals back to original df
df = df.merge(totals, on=['month', 'category'], how='left')

# Step 2: Calculate contributions as percentages
df['sales_qty_contribution'] = (df['sales_qty'] / df['total_qty_cat'] * 100).round(0).astype(int).astype(str) + '%'
df['sales_amt_contribution'] = (df['sales_amt'] / df['total_amt_cat'] * 100).round(0).astype(int).astype(str) + '%'
df['sales_cost_contribution'] = (df['sales_cost'] / df['total_cost_cat'] * 100).round(0).astype(int).astype(str) + '%'
df['profit_contribution'] = (df['profit'] / df['total_profit_cat'] * 100).round(0).astype(int).astype(str) + '%'

# Step 3: Pivot table 
pivot_df = df.pivot_table(
    index='product',
    columns='month',
    values=['sales_qty_contribution', 'sales_amt_contribution', 'sales_cost_contribution', 'profit_contribution'],
    aggfunc='first'  
)

# Flatten MultiIndex columns
pivot_df.columns = [f"{month}_{metric}_by_category" for metric, month in pivot_df.columns]
pivot_df = pivot_df.reset_index()

# Step 4: Sort by product
pivot_df = pivot_df.sort_values('product')

# Display the result
print(pivot_df)

# Step 5: Optional Export to Excel
pivot_df.to_excel("final_pivot_table.xlsx", index=False)
